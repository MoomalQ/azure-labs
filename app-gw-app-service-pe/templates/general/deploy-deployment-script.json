{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "appGwName": {
            "type": "string",
            "metadata": {
                "description": "The name of the App Gateway"
            }
        },
        "customWebDomain": {
            "type": "string",
            "metadata": {
                "description": "The domain name used in the certificate that is generated"
            }
        },
        "deploymentScriptUmiResId": {
            "type": "string",
            "metadata": {
                "description": "The resource id of the UMI used to run the deployment script"
            }
        },
        "keyVaultName": {
            "type": "string",
            "metadata": {
                "description": "The name of the Key Vault to store the certificate"
            }
        },
        "tags": {
            "type": "object",
            "metadata": {
                "description": "The tags that will be associated to the resources"
            },
            "defaultValue": {
                "environment": "lab"
            }
        },
        "transitRgName": {
            "type": "string",
            "metadata": {
                "description": "The name of the transit resource group"
            }
        },
        "webAppName": {
            "type": "string",
            "metadata": {
                "description": "The name that will be assigned to the Web App"
            }
        }
    },
    "variables": {
        "agw-cert-name": "appservice",
        "appServicesFqdn": "[concat(parameters('webAppName'),'.azurewebsites.net')]",
        "deployScriptApiVersion": "2020-10-01",
        "deployScriptName": "post-config-agw",
        "deployScriptUri": "[uri(deployment().properties.templateLink.uri, '../../scripts/config-agw.sh')]",
        "location": "[resourceGroup().location]"
    },
    "resources": [
        {
            "name": "[variables('deployScriptName')]",
            "type": "Microsoft.Resources/deploymentScripts",
            "apiVersion": "[variables('deployScriptApiVersion')]",
            "dependsOn": [
            ],
            "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                    "[parameters('deploymentScriptUmiResId')]": {}
                }
            },
            "location": "[variables('location')]",
            "kind": "AzureCLI",
            "tags": "[parameters('tags')]",
            "properties": {
                "azCliVersion": "2.24.2",
                "cleanupPreference": "Always",
                "primaryScriptUri": "[variables('deployScriptUri')]",
                "environmentVariables": [
                    {
                        "name": "AGW_CERT_NAME",
                        "value": "[variables('agw-cert-name')]"
                    },
                    {
                        "name": "AGW_NAME",
                        "value": "[parameters('appGwName')]"
                    },
                    {
                        "name": "APP_FQDN",
                        "value": "[variables('appServicesFqdn')]"
                    },
                    {
                        "name": "DOMAIN_NAME",
                        "value": "[parameters('customWebDomain')]"
                    },
                    {
                        "name": "KV_NAME",
                        "value": "[parameters('keyVaultName')]"
                    },
                    {
                        "name": "TRANSIT_RG",
                        "value": "[parameters('transitRgName')]"
                    }
                ],
                "retentionInterval": "P1D",
                "timeout": "PT10M"
            }
        }
    ],
    "outputs": {
    }
}
